<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CHS Itinerary Builder — Wave 0.8.3 (Full, Debugged)</title>
<style>
  :root{
    --bg:#0b0c0f; --panel:#12141a; --ink:#e8ebf0; --muted:#a9b1bd; --accent:#5ea1ff;
    --chip1:#98c1ff; --chip2:#ffd280; --chip3:#b4f0d9; --chip4:#ffb3c1; --chipOff:#1a212e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}

  /* App grid with named areas and stable widths */
  .app{display:grid;grid-template-columns:minmax(300px,340px) minmax(520px,1fr) minmax(360px,440px);grid-template-areas:'left center right';gap:16px;padding:16px;max-width:1440px;margin:0 auto}
  @media (max-width:1279px){
    .app{grid-template-columns:minmax(320px,420px) 1fr;grid-template-areas:'left center' 'right right';gap:14px}
  }
  @media (max-width:1023px){
    .app{grid-template-columns:1fr;grid-template-areas:'left' 'center' 'right';gap:12px}
  }

  .left{grid-area:left}
  .center{grid-area:center}
  .right{grid-area:right}
  @media (min-width:1280px){.left{position:sticky;top:16px;align-self:start;height:fit-content}}

  .card{background:var(--panel);border:1px solid #1d212b;border-radius:16px;padding:16px;overflow:hidden;position:relative;display:flex;flex-direction:column;min-height:0}
  h2{margin:0 0 12px 0;font-size:14px;letter-spacing:.02em;text-transform:uppercase;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row.nowrap{flex-wrap:nowrap;min-width:0}
  .row.space-between{justify-content:space-between}
  .row.stick-right{justify-content:flex-end}
  .section{margin-top:12px}
  button{appearance:none;border:1px solid #2a2f3a;background:#141821;color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;flex:0 0 auto;min-height:36px}
  button:hover{border-color:#3a4150}
  .iconbtn{width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center}
  .iconbtn svg{width:24px;height:24px}
  .toolicon{width:44px;height:44px;border:1px solid #2a2f3a;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#141821}
  .toolicon svg{width:24px;height:24px}
  .input{background:#0f1218;border:1px solid #2a2f3a;color:var(--ink);padding:10px 12px;border-radius:10px}

  /* Calendar */
  .calendar{display:grid;grid-template-rows:48px 20px 1fr;gap:8px;min-height:440px}
  .cal-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;height:48px;min-width:0;flex-wrap:nowrap}
  .cal-month{display:flex;flex-direction:column;justify-content:center;min-width:160px}
  .cal-month .month{font-size:20px;font-weight:600}
  .cal-month .year{font-size:12px;color:var(--muted)}
  .navrow{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;min-width:0}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-size:11px;color:var(--muted);text-align:center}
  .days{grid-auto-rows:1fr;min-height:352px;contain:layout paint}
  .day{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:12px;border:1px solid #222733;background:#0f1218;cursor:pointer;position:relative}
  .day.faded{opacity:.45}
  .day.faded:hover{opacity:.9;background:#10141d}
  .day.focus{outline:2px solid var(--accent)}
  .day.stay{background:#0d1a2e}
  .day.arrival,.day.departure{background:#12233d;border-color:#2a73ff}
  .day.today::after{content:"";position:absolute;bottom:6px;width:6px;height:6px;border-radius:50%;background:var(--accent)}

  /* Guests */
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;max-height:160px;overflow:auto;padding-right:4px}
  .chip{padding:6px 10px;border-radius:999px;border:2px solid transparent;display:flex;align-items:center;gap:8px;cursor:pointer;transition:background .15s,border-color .15s,box-shadow .15s;position:relative}
  .chip .x{font-weight:700;opacity:.95;cursor:pointer;padding:2px 10px;margin-left:6px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;line-height:22px;background:#0f1420;border:1px solid #2a3242;pointer-events:auto}
  .chip .x:hover{opacity:1;background:#0e1624;border-color:#3a4254}
  .chip .star{font-size:28px;line-height:1;position:relative;top:1px;margin-right:6px;color:#cbd6ff}
  .chip.off{background:var(--chipOff);color:#7d8aa0;border-color:#2b3445}
  .chip.on{box-shadow:0 0 0 2px rgba(255,255,255,.06) inset}

  /* Activity list */
  .list{display:flex;flex-direction:column;gap:8px}
  .item{padding:10px 12px;border:1px solid #212635;border-radius:12px;background:#0f131a;display:flex;justify-content:space-between;align-items:center}
  .item .title{font-weight:600;display:flex;align-items:center;gap:6px}
  .item .time{color:var(--muted);font-variant-numeric:tabular-nums}
  .initial{display:inline-block;min-width:24px;padding:0 10px;height:28px;line-height:28px;border-radius:999px;border:1px solid currentColor;font-size:13px;text-align:center;cursor:pointer;transition:background .15s, box-shadow .15s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none;}
  .initial:hover{background:#0f1a2a;box-shadow:0 0 0 2px rgba(255,255,255,.05) inset}
  .tag{margin-left:8px;padding:2px 6px;border-radius:999px;border:1px solid #2b3240;color:#cbd6ff;min-width:22px;text-align:center;cursor:default}

  /* Email */
  .email{white-space:pre-wrap;background:#0d1016;border:1px solid #1e2431;padding:12px;border-radius:12px;min-height:200px;flex:1;min-height:0;overflow:auto}
</style>
</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <section class="left card">
      <h2>Calendar</h2>
      <div class="calendar">
        <div class="cal-toolbar nowrap">
          <div class="cal-month"><span class="month" id="calMonth"></span><span class="year" id="calYear"></span></div>
          <div class="navrow nowrap">
            <button id="yPrev" class="iconbtn" title="Prev Year" aria-label="Previous Year">⟪</button>
            <button id="mPrev" class="iconbtn" title="Prev Month" aria-label="Previous Month">◀︎</button>
            <button id="btnToday" title="Today">Today</button>
            <button id="mNext" class="iconbtn" title="Next Month" aria-label="Next Month">▶︎</button>
            <button id="yNext" class="iconbtn" title="Next Year" aria-label="Next Year">⟫</button>
          </div>
        </div>
        <div class="grid" id="dow"></div>
        <div class="grid days" id="calGrid"></div>
      </div>
      <div class="section">
        <div class="row">
          <button id="btnArrival">Arrival</button>
          <label class="row"><span class="muted">ETA</span><input class="input" id="eta" type="time" value="12:00" aria-label="ETA"></label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnDeparture">Departure</button>
          <label class="row"><span class="muted">ETD</span><input class="input" id="etd" type="time" value="13:00" aria-label="ETD"></label>
        </div>
      </div>
      <div class="section">
        <h2>Guests</h2>
        <div class="row nowrap" style="width:100%">
          <input class="input" id="guestName" placeholder="Name?" style="flex:1;min-width:0"/>
          <button id="addGuest">Add</button>
          <button id="toggleAll">Toggle All</button>
        </div>
        <div class="chips" id="guests"></div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="center card">
      <div class="row space-between nowrap" style="align-items:baseline">
        <h2>Activities</h2>
        <div class="row nowrap">
          <button id="prevDay" class="iconbtn" title="Previous Day" aria-label="Previous Day">◀︎</button>
          <div id="dayTitle" class="muted" style="min-width:220px;text-align:center"></div>
          <button id="nextDay" class="iconbtn" title="Next Day" aria-label="Next Day">▶︎</button>
        </div>
      </div>
      <div class="row nowrap" style="margin-bottom:12px">
        <button id="addDinner">Dinner</button>
        <button id="addCustom">Custom</button>
        <button id="clearAll">Clear</button>
      </div>
      <div id="activities" class="list" style="flex:1;min-height:0;overflow:auto"></div>
    </section>

    <!-- RIGHT -->
    <section class="right card">
      <h2>Preview</h2>
      <div id="email" class="email" contenteditable="false" spellcheck="false"></div>
      <div class="row stick-right nowrap" style="gap:8px;margin-top:12px">
        <button id="toggleEdit" class="toolicon" title="Edit/Lock" aria-label="Edit or Lock Preview">
          <svg id="editIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19 3 20l1-4 12.5-12.5z"/>
          </svg>
        </button>
        <button id="copy" class="toolicon" title="Copy" aria-label="Copy">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>
      </div>
    </section>
  </div>

<script>
// ------------------------
// State & helpers
// ------------------------
const state = {
  today: new Date(),
  focus: new Date(),
  monthView: null, // {y,m}
  arrival: null,
  departure: null,
  eta: '12:00',
  etd: '13:00',
  guests: [], // {name,color,primary,active}
  itemsByDate: new Map(), // dateKey => [{start,end,title,type,guests:Set(names)}]
  emailLocked:false,
  emailDirty:false,
}
const COLORS=['var(--chip1)','var(--chip2)','var(--chip3)','var(--chip4)']
function pad(n){return String(n).padStart(2,'0')}
function fmtDateKey(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function fromDateKey(k){const [y,m,d]=k.split('-').map(Number);return new Date(y,m-1,d)}
function weekdayName(d){return d.toLocaleDateString(undefined,{weekday:'long'})}
function monthName(y,m){return new Date(y,m,1).toLocaleString(undefined,{month:'long'})}
function ordinal(n){const s=["th","st","nd","rd"],v=n%100;return n+(s[(v-20)%10]||s[v]||s[0])}
function hmToAmPm(hm){let [h,m]=hm.split(':').map(Number);const am=h<12;h=((h+11)%12)+1;return `${h}:${pad(m)}${am?'am':'pm'}`}
function ensureDayList(key){ if(!state.itemsByDate.has(key)) state.itemsByDate.set(key,[]) }
function keyFor(it){return `${it.start}|${it.end||''}|${it.title}`}

// Demo catalog (Late Summer Monday list + a few extras for other days)
const program = {
  Sunday:[{start:'09:30',end:'10:15',title:'Nature Walk'}],
  Monday:[
    {start:'06:45',end:'08:15',title:'Overlook Hike'},
    {start:'07:00',end:'09:15',title:'Scenic Desert E-Bike Ride'},
    {start:'07:00',end:'10:00',title:'Castle Peak Via Ferrata Climb'},
    {start:'07:00',end:'10:00',title:'Crater Canyon Exploration'},
    {start:'08:30',end:'09:25',title:'Rise & Shine Flow Yoga'},
    {start:'09:00',end:'10:15',title:'E-Biking 101: Intro to E-Bike Tour'},
    {start:'09:30',end:'10:15',title:'Landscape Restoration and Development Tour'},
    {start:'09:40',end:'10:00',title:'Meditation'},
    {start:'10:00',end:'10:45',title:'Guided Archery'},
    {start:'10:15',end:'11:00',title:'Intro to Tai Chi'},
    {start:'10:30',end:'11:30',title:'Farm Tour'},
    {start:'11:00',end:'11:45',title:'Axe Throwing'},
    {start:'11:00',end:'12:00',title:'Paddle Board Yoga'},
    {start:'12:30',end:'13:30',title:'Sound Bath'},
    {start:'14:00',end:'14:45',title:'Mindfulness Activity - Rock Mandalas'},
    {start:'14:00',end:'15:00',title:'Cooling Aroma Restorative Yoga'},
    {start:'15:00',end:'16:00',title:'Wine Tasting'},
    {start:'15:15',end:'16:10',title:'Yoga'},
    {start:'16:00',end:'16:45',title:'Castle Hot Springs Documentary Viewing'},
    {start:'16:00',end:'17:00',title:'Connecting With Water'},
    {start:'16:30',end:'17:00',title:'Yoga Nidra'}
  ],
  Tuesday:[{start:'09:00',end:'12:00',title:'UTV Razor Tour'},{start:'16:00',end:'17:00',title:'Farm Tour'}],
  Wednesday:[{start:'10:15',end:'11:00',title:'Intro to Tai Chi'}],
  Thursday:[{start:'11:30',end:'12:15',title:'Guided Archery'}],
  Friday:[{start:'12:30',end:'13:30',title:'Sound Bath'}],
  Saturday:[{start:'09:00',end:'10:00',title:'Morning Stretch'}]
}
function getProgramForDate(d){return (program[weekdayName(d)]||[]).map(x=>({...x}))}

// ------------------------
// Calendar (Sunday-first) with faded filler days (clickable) and fixed 6-row grid
// ------------------------
function renderCalendar(){
  const mv = state.monthView
  const ref = mv? new Date(mv.y,mv.m,1) : new Date(state.focus.getFullYear(),state.focus.getMonth(),1)
  document.getElementById('calMonth').textContent = monthName(ref.getFullYear(),ref.getMonth())
  document.getElementById('calYear').textContent = ref.getFullYear()

  const dowEl=document.getElementById('dow'); dowEl.innerHTML=''
  ;['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const c=document.createElement('div');c.className='dow';c.textContent=d;dowEl.appendChild(c)})

  const grid=document.getElementById('calGrid'); grid.innerHTML=''
  const first=new Date(ref.getFullYear(),ref.getMonth(),1)
  const startWd=first.getDay() // Sun=0
  const totalCells=42 // always 6 rows to prevent layout jump
  for(let i=0;i<totalCells;i++){
    const dateObj=new Date(ref.getFullYear(),ref.getMonth(),1 - startWd + i)
    const inMonth = dateObj.getMonth()===ref.getMonth()
    const btn=document.createElement('button'); btn.className='day'+(inMonth?'':' faded'); btn.textContent=dateObj.getDate()
    const today=new Date(); today.setHours(0,0,0,0)
    const cd=new Date(dateObj); cd.setHours(0,0,0,0)
    if(cd.getTime()===today.getTime()) btn.classList.add('today')
    if(state.arrival){const a=new Date(state.arrival).setHours(0,0,0,0); if(cd.getTime()===a) btn.classList.add('arrival')}
    if(state.departure){const d=new Date(state.departure).setHours(0,0,0,0); if(cd.getTime()===d) btn.classList.add('departure')}
    if(state.arrival && state.departure){const a=new Date(state.arrival).setHours(0,0,0,0); const d=new Date(state.departure).setHours(0,0,0,0); const k=cd.getTime(); if(k>a&&k<d) btn.classList.add('stay')}
    if(cd.toDateString()===state.focus.toDateString()) btn.classList.add('focus')
    btn.addEventListener('click',()=>{ state.focus=new Date(dateObj); if(!inMonth){ state.monthView={y:dateObj.getFullYear(),m:dateObj.getMonth()} } renderAll() })
    grid.appendChild(btn)
  }
  document.getElementById('mPrev').onclick=()=>{ const y=ref.getFullYear(),m=ref.getMonth()-1; state.monthView={y:y+(m<0?-1:0), m:(m+12)%12}; renderCalendar() }
  document.getElementById('mNext').onclick=()=>{ const y=ref.getFullYear(),m=ref.getMonth()+1; state.monthView={y:y+(m>11?1:0), m:(m+12)%12}; renderCalendar() }
  document.getElementById('yPrev').onclick=()=>{ state.monthView={y:ref.getFullYear()-1,m:ref.getMonth()}; renderCalendar() }
  document.getElementById('yNext').onclick=()=>{ state.monthView={y:ref.getFullYear()+1,m:ref.getMonth()}; renderCalendar() }
  document.getElementById('btnToday').onclick=()=>{ state.focus=new Date(); state.monthView=null; renderAll() }
}

// ------------------------
// Guests
// ------------------------
function addGuest(name){
  name=name?.trim(); if(!name) return
  const color=COLORS[state.guests.length%COLORS.length]
  const primary=state.guests.length===0
  state.guests.push({name,color,primary,active:true})
  renderGuests(); renderActivities(); renderEmail()
}
function removeGuest(i){
  const wasPrimary=state.guests[i].primary
  state.guests.splice(i,1)
  if(wasPrimary && state.guests[0]) state.guests[0].primary=true
  renderGuests(); renderActivities(); renderEmail()
}
function renderGuests(){
  const wrap=document.getElementById('guests'); wrap.innerHTML=''
  state.guests.forEach((g,i)=>{
    const el=document.createElement('div'); el.className='chip';
    el.classList.add(g.active? 'on':'off')
    el.style.borderColor=g.active? g.color : '#2b3445'
    el.style.color=g.active? '#e7f0ff' : '#7d8aa0'
    el.style.background=g.active? 'linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00))' : 'var(--chipOff)'
    if(g.active) el.style.boxShadow = `0 0 0 2px ${g.color} inset`

    const star=g.primary? '<span class="star">⋆</span>':''
    el.innerHTML = `${star}<strong>${g.name}</strong>`

    const x=document.createElement('span'); x.className='x'; x.textContent='×';
    x.setAttribute('role','button'); x.setAttribute('aria-label', `Remove ${g.name}`);
    x.tabIndex=0; x.title='Remove';
    const onRemove=(e)=>{ e.preventDefault(); e.stopPropagation(); removeGuest(i) };
    x.addEventListener('pointerdown', onRemove);
    x.addEventListener('click', onRemove);
    x.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') onRemove(e) });

    el.addEventListener('click', (e)=>{ if(e.target.classList.contains('x')) return; g.active=!g.active; renderGuests(); renderActivities() })
    el.appendChild(x)
    wrap.appendChild(el)
  })
}

// ------------------------
// Activities (chips + Everyone expansion on touch)
// ------------------------
const activitiesEl=document.getElementById('activities')
const dayTitleEl=document.getElementById('dayTitle')
let expandedEveryoneTag = null; // tracks the currently expanded 'Everyone' tag on touch
function collapseExpandedTag(){
  if(expandedEveryoneTag){
    expandedEveryoneTag.textContent = 'Everyone';
    expandedEveryoneTag._expanded = false;
    expandedEveryoneTag = null;
  }
}
function renderActivities(){
  const d=state.focus
  dayTitleEl.textContent = `${weekdayName(d)}, ${monthName(d.getFullYear(),d.getMonth())} ${ordinal(d.getDate())}`
  const base=getProgramForDate(d)
  const key=fmtDateKey(d)
  const added=(state.itemsByDate.get(key)||[])
  const addedMap=new Map(added.map(it=>[keyFor(it),it]))
  activitiesEl.innerHTML=''

  function renderRow(item, isCatalog){
    const existing = addedMap.get(keyFor(item))
    const merged = existing? existing : {...item, type:'activity'}
    const row=document.createElement('div'); row.className='item'
    const left=document.createElement('div')
    const t=document.createElement('div'); t.className='title'; t.textContent=merged.title
    const time=document.createElement('div'); time.className='time'; time.textContent = merged.end? `${hmToAmPm(merged.start)} - ${hmToAmPm(merged.end)}` : hmToAmPm(merged.start)

    // Chips by title (button-like with hover/touch highlight)
    if(merged.guests && merged.guests.size){
      const names=Array.from(merged.guests)
      const everyone = state.guests.length>0 && names.length===state.guests.length
      if(everyone){
        const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Everyone'; tag.setAttribute('role','button'); tag.tabIndex=0; tag.title='Show guests'
        const open = ()=>{
          if(tag._expanded) return; tag._expanded=true; tag._old='Everyone'; tag.textContent='';
          names.forEach(n=>{const chip=document.createElement('span'); chip.className='initial'; chip.textContent=(n[0]||'?').toUpperCase(); chip.style.color=(state.guests.find(g=>g.name===n)?.color||'#cbd6ff'); chip.setAttribute('role','button'); chip.setAttribute('aria-label',`Remove ${n} from this activity`);
            const removeOne=(e)=>{ e.preventDefault(); e.stopPropagation(); const s=new Set(merged.guests); s.delete(n); merged.guests=s; if(s.size===0){ const arr=state.itemsByDate.get(key)||[]; const idx=arr.indexOf(merged); if(idx>-1) arr.splice(idx,1) } collapseExpandedTag(); renderAll() };
            chip.addEventListener('pointerdown', removeOne);
            chip.addEventListener('click', removeOne);
            tag.appendChild(chip) })
          expandedEveryoneTag = tag;
        }
        const close = ()=>{ tag.textContent='Everyone'; tag._expanded=false; if(expandedEveryoneTag===tag) expandedEveryoneTag=null }
        // Desktop hover behavior
        tag.onmouseenter=()=>{ if('ontouchstart' in window) return; open() }
        tag.onmouseleave=()=>{ if('ontouchstart' in window) return; close() }
        // Touch / click toggle behavior
        tag.addEventListener('pointerdown',(e)=>{ e.preventDefault(); e.stopPropagation(); if(tag._expanded){ close() } else { collapseExpandedTag(); open() } })
        tag.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); if(tag._expanded){ close() } else { collapseExpandedTag(); open() } } })
        t.appendChild(tag)
      } else {
        names.forEach(n=>{ const chip=document.createElement('span'); chip.className='initial'; chip.textContent=(n[0]||'?').toUpperCase(); chip.style.color=(state.guests.find(g=>g.name===n)?.color||'#cbd6ff'); chip.title=n; chip.setAttribute('role','button'); chip.setAttribute('aria-label',`Remove ${n} from this activity`);
          const removeOne=(e)=>{ e.preventDefault(); e.stopPropagation(); const s=new Set(merged.guests); s.delete(n); merged.guests=s; if(s.size===0){ const arr=state.itemsByDate.get(key)||[]; const idx=arr.indexOf(merged); if(idx>-1) arr.splice(idx,1) } renderAll() };
          chip.addEventListener('pointerdown', removeOne);
          chip.addEventListener('click', removeOne);
          t.appendChild(chip) })
      }
    }

    left.append(t,time)
    const right=document.createElement('div')
    const add=document.createElement('button'); add.textContent='+'; add.title='Add for toggled guests'
    add.onclick=()=>{
      const actives=state.guests.filter(g=>g.active).map(g=>g.name)
      if(actives.length===0){ alert('Toggle at least one guest first.'); return }
      ensureDayList(key)
      const arr=state.itemsByDate.get(key)
      const target=addedMap.get(keyFor(item))||merged
      const s=new Set(target.guests||[]); actives.forEach(n=>s.add(n)); target.guests=s; if(!arr.includes(target)) arr.push(target)
      state.emailDirty=false; renderAll()
    }
    right.appendChild(add)

    row.append(left,right)
    activitiesEl.appendChild(row)
  }

  base.forEach(it=>renderRow(it,true))
  added.filter(it=>!base.some(b=>keyFor(b)===keyFor(it))).sort((a,b)=>a.start.localeCompare(b.start)).forEach(it=>renderRow(it,false))
}

// collapse expanded Everyone on outside tap
const DocumentClickHandler = (e)=>{ if(expandedEveryoneTag && !expandedEveryoneTag.contains(e.target)) collapseExpandedTag() }
document.addEventListener('pointerdown', DocumentClickHandler, {capture:true})

// ------------------------
// Email preview (inline edit with Cmd/Ctrl + dblclick)
// ------------------------
const emailEl=document.getElementById('email')
function dateHeadingFromKey(k){const d=fromDateKey(k);return `${weekdayName(d)}, ${d.toLocaleString(undefined,{month:'long'})} ${ordinal(d.getDate())}`}
function generateEmail(){
  const pg=state.guests.find(g=>g.primary)
  const hello=pg? pg.name : 'Guest'
  const lines=[]
  lines.push(`Hello ${hello},`)
  lines.push('')
  lines.push('Current Itinerary:')
  const dayKeys=new Set(Array.from(state.itemsByDate.keys()))
  if(state.arrival) dayKeys.add(fmtDateKey(state.arrival))
  if(state.departure) dayKeys.add(fmtDateKey(state.departure))
  const keys=Array.from(dayKeys).sort()
  for(const k of keys){
    const items=(state.itemsByDate.get(k)||[]).slice().sort((a,b)=>a.start.localeCompare(b.start))
    const isArr=state.arrival && k===fmtDateKey(state.arrival)
    const isDep=state.departure && k===fmtDateKey(state.departure)
    if(items.length===0 && !isArr && !isDep) continue
    lines.push('')
    lines.push(dateHeadingFromKey(k))
    if(isArr){ lines.push(`4:00pm Guaranteed Check-In | Welcome to arrive as early as 12:00pm`) }
    for(const it of items){ const timeTxt=it.end? `${hmToAmPm(it.start)} - ${hmToAmPm(it.end)}` : hmToAmPm(it.start); lines.push(`${timeTxt} | ${it.title}`) }
    if(isDep){ lines.push(`11:00am Check-Out | Welcome to stay on property until 1:00pm`) }
  }
  return lines.join('\n')
}
function renderEmail(){ if(state.emailLocked || state.emailDirty) return; emailEl.textContent = generateEmail() }
emailEl.addEventListener('dblclick',(e)=>{
  if(!(e.metaKey||e.ctrlKey)) return
  state.emailLocked=!state.emailLocked; emailEl.contentEditable=state.emailLocked
  const lock='<rect x="3" y="10" width="18" height="11" rx="2"/><path d="M7 10V7a5 5 0 0 1 10 0v3"/>'
  const pencil='<path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19 3 20l1-4 12.5-12.5z"/>'
  document.getElementById('editIcon').innerHTML = state.emailLocked ? lock : pencil
  if(state.emailLocked) state.emailDirty=true
})
emailEl.addEventListener('input',()=>{ if(state.emailLocked) state.emailDirty=true })

// ------------------------
// Quick add / controls
// ------------------------
function addDinner(){
  const hm=prompt('Dinner start time (HH:MM, 15-min steps between 17:30 and 20:00, excluding 18:45):','19:00'); if(!hm) return
  const [H,M]=hm.split(':').map(Number); const mins=H*60+M
  const ok=!(mins<17*60+30 || mins>20*60 || M%15!==0 || hm==='18:45')
  if(!ok){ alert('Invalid dinner time.'); return }
  const key=fmtDateKey(state.focus); ensureDayList(key)
  const actives=state.guests.filter(g=>g.active).map(g=>g.name); if(actives.length===0){ alert('Toggle at least one guest first.'); return }
  state.itemsByDate.get(key).push({start:hm,end:null,title:'Dinner at Harvest',type:'dinner',guests:new Set(actives)})
  state.emailDirty=false; renderAll()
}
function addCustom(){
  const title=prompt('Custom title:','Custom Activity'); if(!title) return
  const start=prompt('Start time (HH:MM):','10:00'); if(!start) return
  const end=prompt('End time (HH:MM, optional):','')||null
  const key=fmtDateKey(state.focus); ensureDayList(key)
  const actives=state.guests.filter(g=>g.active).map(g=>g.name); if(actives.length===0){ alert('Toggle at least one guest first.'); return }
  state.itemsByDate.get(key).push({start,end,title,type:'custom',guests:new Set(actives)})
  state.emailDirty=false; renderAll()
}
function clearAll(){
  // Instant nuke: no confirm
  state.arrival=null; state.departure=null;
  state.itemsByDate = new Map();
  state.guests=[];
  document.getElementById('eta').value='12:00'; document.getElementById('etd').value='13:00'; state.eta='12:00'; state.etd='13:00'
  state.emailLocked=false; state.emailDirty=false; emailEl.contentEditable=false; document.getElementById('editIcon').innerHTML='<path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19 3 20l1-4 12.5-12.5z"/>'
  renderAll()
}

// ------------------------
// Wire-up
// ------------------------
function renderAll(){ renderCalendar(); renderGuests(); renderActivities(); renderEmail() }

// Calendar A/D guardrails
 document.getElementById('btnArrival').onclick=()=>{ const d=new Date(state.focus); if(state.departure && d>state.departure){ alert('Arrival cannot be after Departure.'); return } state.arrival=d; state.emailDirty=false; renderAll() }
 document.getElementById('btnDeparture').onclick=()=>{ const d=new Date(state.focus); if(state.arrival && d<state.arrival){ alert('Departure cannot be before Arrival.'); return } state.departure=d; state.emailDirty=false; renderAll() }
 document.getElementById('eta').onchange=(e)=>{ state.eta=e.target.value; renderAll() }
 document.getElementById('etd').onchange=(e)=>{ state.etd=e.target.value; renderAll() }
 document.getElementById('prevDay').onclick=()=>{ const d=new Date(state.focus); d.setDate(d.getDate()-1); state.focus=d; state.monthView=null; renderAll() }
 document.getElementById('nextDay').onclick=()=>{ const d=new Date(state.focus); d.setDate(d.getDate()+1); state.focus=d; state.monthView=null; renderAll() }
 document.getElementById('addDinner').onclick=addDinner
 document.getElementById('addCustom').onclick=addCustom
 document.getElementById('clearAll').onclick=clearAll
 document.getElementById('addGuest').onclick=()=>{ const n=document.getElementById('guestName'); addGuest(n.value); n.value=''; n.focus() }
 document.getElementById('guestName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); const n=e.target; addGuest(n.value); n.value=''; } })
 document.getElementById('toggleAll').onclick=()=>{ const anyOff=state.guests.some(g=>!g.active); state.guests.forEach(g=>g.active=anyOff); renderGuests(); renderActivities() }
 document.getElementById('toggleEdit').onclick=()=>{ const evt=new Event('dblclick'); evt.metaKey=true; emailEl.dispatchEvent(evt) }
 document.getElementById('copy').onclick=async()=>{ const text=emailEl.textContent; try{ await navigator.clipboard.writeText(text); alert('Copied email to clipboard'); }catch(e){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Copied (fallback)') } }

// Keyboard shortcuts (require Cmd/Ctrl)
 document.addEventListener('keydown',e=>{
  if(!(e.metaKey||e.ctrlKey)) return
  if(e.key==='t' || e.key==='T'){ e.preventDefault(); state.focus=new Date(); state.monthView=null; renderAll() }
  if(e.key==='a' || e.key==='A'){ e.preventDefault(); const d=new Date(state.focus); if(state.departure && d>state.departure){ alert('Arrival cannot be after Departure.'); return } state.arrival=d; state.emailDirty=false; renderAll() }
  if(e.key==='d' || e.key==='D'){ e.preventDefault(); const d=new Date(state.focus); if(state.arrival && d<state.arrival){ alert('Departure cannot be before Arrival.'); return } state.departure=d; state.emailDirty=false; renderAll() }
  if(e.key===',' || e.code==='Comma'){ e.preventDefault(); const d=new Date(state.focus); d.setDate(d.getDate()-1); state.focus=d; state.monthView=null; renderAll() }
  if(e.key==='.' || e.code==='Period'){ e.preventDefault(); const d=new Date(state.focus); d.setDate(d.getDate()+1); state.focus=d; state.monthView=null; renderAll() }
 })

// ------------------------
// Minimal self-tests (run by adding #test to URL)
// ------------------------
function assert(cond, msg){ if(!cond){ console.error('[TEST FAIL]', msg); throw new Error(msg) } }
function runSelfTests(){
  console.log('[TEST] starting');
  // test guest add/remove
  addGuest('Test A'); addGuest('Test B');
  assert(state.guests.length===2, 'should have 2 guests');
  // simulate clicking first pill's ×
  renderGuests(); const firstX=document.querySelector('.chip .x'); if(firstX){ firstX.click() }
  assert(state.guests.length===1 && state.guests[0].name==='Test B','pill delete should remove without confirm');
  // test arrival/dep guardrails
  const oldFocus=new Date(state.focus);
  state.focus=new Date(2025,8,1); document.getElementById('btnArrival').click();
  state.focus=new Date(2025,7,31); // day before
  document.getElementById('btnDeparture').click(); // should be blocked and unchanged
  assert(!state.departure || state.departure>=state.arrival,'dep cannot be before arrival');
  state.focus=oldFocus;
  // test add activity via button
  const before=(state.itemsByDate.get(fmtDateKey(state.focus))||[]).length;
  if(state.guests.length===0) addGuest('X'); state.guests[0].active=true; renderActivities();
  const firstAdd=document.querySelector('#activities .item button'); if(firstAdd) firstAdd.click();
  const after=(state.itemsByDate.get(fmtDateKey(state.focus))||[]).length;
  assert(after>=before,'adding activity increased or created entry');
  // test clear wipes everything without confirm
  clearAll();
  assert(state.guests.length===0 && state.itemsByDate.size===0 && !state.arrival && !state.departure, 'clearAll should wipe all state')
  console.log('[TEST] passed');
}
if(location.hash==="#test"){ try{ runSelfTests() }catch(e){ console.error(e) } }

// Boot
state.monthView=null; renderAll()
</script>
</body>
</html>
