<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CHS Itinerary Builder — Rescue</title>
<style>
:root{
  --bg:#f7f8fb; --panel:#fff; --ink:#0c1220; --muted:#5b6575; --accent:#2a6bff;
  --chip1:#2a6bff; --chip2:#ff8c3a; --chip3:#0aa06e; --chip4:#e23b6e; --chipOff:#e9edf7;
  --border:#dbe1ef; --shadow:0 1px 2px rgba(12,18,32,.06), 0 6px 24px rgba(12,18,32,.06);
}
body.theme-dark{
  --bg:#0b0c0f; --panel:#12141a; --ink:#e8ebf0; --muted:#a9b1bd; --accent:#5ea1ff;
  --chip1:#98c1ff; --chip2:#ffd280; --chip3:#b4f0d9; --chip4:#ffb3c1; --chipOff:#1a212e;
  --border:#1d212b; --shadow:0 1px 2px rgba(0,0,0,.35), 0 6px 24px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font:15px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}
.app{
  display:grid;
  grid-template-columns:minmax(300px,340px) minmax(520px,1fr) minmax(360px,430px);
  grid-template-areas:"left center right";
  gap:16px;padding:16px;max-width:1440px;margin:0 auto;
}
.left{grid-area:left}
.center{grid-area:center}
.right{grid-area:right}
@media(min-width:1280px){ .left{position:sticky;top:16px;align-self:start;height:fit-content} }
@media(max-width:1279px){
  .app{ grid-template-columns:minmax(320px,420px) 1fr; grid-template-areas:"left center" "right right"; gap:14px; }
}
@media(max-width:1023px){
  .app{ grid-template-columns:1fr; grid-template-areas:"left" "center" "right"; gap:12px; }
}
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;
  position:relative;display:flex;flex-direction:column;min-height:0;overflow:hidden;box-shadow:var(--shadow);
}
h2{margin:0 0 12px 0;font-size:14px;letter-spacing:.02em;text-transform:uppercase;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.row.nowrap{flex-wrap:nowrap;min-width:0}
.row.space-between{justify-content:space-between}
.row.stick-right{justify-content:flex-end}
.row.tight{gap:6px}
.spacer-xs{height:6px}
.spacer-sm{height:10px}
.section{margin-top:12px}
button{
  appearance:none;border:1px solid var(--border);background:#f1f4fb;color:var(--ink);
  padding:8px 12px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;min-height:36px;
}
body.theme-dark button{background:#141821;border-color:#2a2f3a;color:var(--ink)}
button:hover{border-color:#c8d2e6} body.theme-dark button:hover{border-color:#3a4150}
.iconbtn{width:30px;height:30px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;padding:0}
.icon{width:16px;height:16px}
.toolicon{width:40px;height:40px;border:1px solid var(--border);border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#f1f4fb}
.toolicon .icon{width:22px;height:22px}
body.theme-dark .toolicon{background:#141821;border-color:#2a2f3a}
.input{background:#fff;border:1px solid var(--border);color:var(--ink);padding:10px 12px;border-radius:10px}
body.theme-dark .input{background:#0f1218;border-color:#2a2f3a}
.select{appearance:none}
.card .card-actions{position:absolute;top:10px;right:10px;display:flex;gap:6px}
.themebtn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:#f1f4fb}
body.theme-dark .themebtn{background:#141821;border-color:#2a2f3a}
.themebtn .icon{width:18px;height:18px}

/* CALENDAR */
.calendar{display:grid;grid-template-rows:auto 20px 1fr auto;gap:10px;min-height:480px}
.cal-toolbar{
  display:grid;
  grid-template-columns:1fr minmax(160px, 260px) 1fr;
  align-items:center;
  gap:12px;
  padding:6px 6px 8px;
  border-bottom:1px solid var(--border);
}
.cal-nav{display:flex;align-items:center;gap:8px;min-width:0;flex-wrap:nowrap}
.cal-nav-left{justify-content:flex-start}
.cal-nav-right{justify-content:flex-end}
.cal-title{display:flex;flex-direction:column;align-items:center;min-width:0;line-height:1.15}
.cal-month{font-size:18px;font-weight:700;letter-spacing:.01em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center}
.cal-year{font-size:12px;color:var(--muted);text-align:center;margin-top:2px}
.grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px;width:100%}
.dow{font-size:11px;color:var(--muted);text-align:center}
.days{grid-auto-rows:1fr;min-height:352px;contain:layout paint}
.day{
  aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:12px;
  border:1px solid var(--border);background:#ffffff;cursor:pointer;position:relative;color:var(--ink);
}
body.theme-dark .day{border-color:#222733;background:#0f1218}
.day.faded{opacity:.55} body.theme-dark .day.faded{opacity:.45}
.day.faded:hover{opacity:.85;background:rgba(0,0,0,.03)} body.theme-dark .day.faded:hover{opacity:.9;background:#10141d}
.day.focus{box-shadow:0 0 0 2px var(--accent), inset 0 0 0 1px var(--accent)} /* no outline clipping */
.day.stay{background:rgba(42,107,255,.06)} body.theme-dark .day.stay{background:#0d1a2e}
.day.arrival,.day.departure{background:rgba(42,107,255,.12);border-color:#2a6bff}
body.theme-dark .day.arrival,body.theme-dark .day.departure{background:#12233d;border-color:#2a73ff}
.day.today::after{content:"";position:absolute;bottom:6px;width:6px;height:6px;border-radius:50%;background:var(--accent)}
.cal-footer{display:flex;justify-content:center}
#btnToday{width:34px;height:34px;border-radius:12px}

/* GUESTS */
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;max-height:160px;overflow:auto;padding-right:4px}
.chip{
  padding:6px 10px;border-radius:999px;border:2px solid transparent;display:flex;align-items:center;gap:8px;cursor:pointer;
  transition:background .15s,border-color .15s,box-shadow .15s;position:relative;
}
.chip .x{
  font-weight:700;opacity:.95;cursor:pointer;padding:2px 10px;margin-left:6px;border-radius:8px;display:inline-flex;
  align-items:center;justify-content:center;min-width:22px;height:22px;line-height:22px;background:#eef2fb;border:1px solid var(--border);pointer-events:auto;
}
body.theme-dark .chip .x{background:#0f1420;border-color:#2a3242}
.chip .x:hover{opacity:1}
.chip .star{
  display:inline-flex;align-items:center;justify-content:center;
  width:18px;height:18px;margin-right:6px;color:#6b78ff;
  font-size:18px;line-height:1;transform:translateY(1px);
}
.chip.off{background:var(--chipOff);color:#7d8aa0;border-color:#cfd6e7}
.chip.on{box-shadow:0 0 0 2px rgba(42,107,255,.25) inset}
body.theme-dark .chip.off{border-color:#2b3445}
body.theme-dark .chip.on{box-shadow:0 0 0 2px rgba(255,255,255,.06) inset}

/* ACTIVITIES */
.list{display:flex;flex-direction:column;gap:8px; scrollbar-gutter: stable both-edges;}
.item{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;display:flex;justify-content:space-between;align-items:center;min-height:48px}
body.theme-dark .item{background:#0f131a;border-color:#212635}
.item .title{font-weight:600;display:flex;align-items:center;gap:6px}
.item .time{color:var(--muted);font-variant-numeric:tabular-nums}
.initial{
  width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;
  border-radius:50%;border:1px solid currentColor;font-size:13px;cursor:pointer;
  transition:background .15s, box-shadow .15s; -webkit-tap-highlight-color: transparent; user-select:none;
}
.initial:hover{background:rgba(0,0,0,.045);box-shadow:0 0 0 2px rgba(0,0,0,.065) inset}
body.theme-dark .initial:hover{background:#0f1c2b;box-shadow:0 0 0 2px rgba(255,255,255,.07) inset}
.tag{
  margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #cfd6e7;color:#2f3d64;min-width:72px;
  display:inline-flex;align-items:center;justify-content:center;position:relative;cursor:default;background:transparent;
}
body.theme-dark .tag{border-color:#2b3240;color:#cbd6ff}

/* floating popover of guest chips for “Everyone” */
.pop{
  position:fixed;z-index:9999;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;gap:6px;flex-wrap:wrap;box-shadow:var(--shadow)
}
.pop .initial{width:26px;height:26px;font-size:12px}

/* EMAIL */
.email{
  white-space:pre-wrap;background:#fff;border:1px solid var(--border);padding:12px;border-radius:12px;min-height:200px;
  flex:1;min-height:0;overflow:auto;color:var(--ink);
}
body.theme-dark .email{background:#0d1016;border-color:#1e2431}

.center-header{gap:10px}
.daytitle{min-width:220px;text-align:center}
#prevDay,#nextDay{width:28px;height:28px;border-radius:10px}
</style>
</head>
<body>
  <!-- inline icons -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-chevron-left" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    <symbol id="i-chevron-right" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    <symbol id="i-chevrons-left" viewBox="0 0 24 24"><polyline points="17 3 7 12 17 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="13 3 3 12 13 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    <symbol id="i-chevrons-right" viewBox="0 0 24 24"><polyline points="7 3 17 12 7 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="11 3 21 12 11 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    <symbol id="i-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="i-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    <symbol id="i-pencil" viewBox="0 0 24 24"><path d="M12 20h9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19 3 20l1-4 12.5-12.5z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    <symbol id="i-lock" viewBox="0 0 24 24"><rect x="3" y="10" width="18" height="11" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 10V7a5 5 0 0 1 10 0v3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="i-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="i-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  </svg>

  <div id="app" class="app">
    <!-- LEFT -->
    <section class="left card">
      <div class="card-actions">
        <button id="themeToggle" class="themebtn" title="Toggle theme"><svg class="icon"><use id="themeUse" href="#i-moon"/></svg></button>
      </div>
      <h2>Calendar</h2>
      <div class="calendar">
        <div class="cal-toolbar">
          <div class="cal-nav cal-nav-left">
            <button id="yPrev" class="iconbtn" title="Previous Year"><svg class="icon"><use href="#i-chevrons-left"/></svg></button>
            <button id="mPrev" class="iconbtn" title="Previous Month"><svg class="icon"><use href="#i-chevron-left"/></svg></button>
          </div>
          <div class="cal-title">
            <div id="calMonth" class="cal-month">Month</div>
            <div id="calYear" class="cal-year">Year</div>
          </div>
          <div class="cal-nav cal-nav-right">
            <button id="mNext" class="iconbtn" title="Next Month"><svg class="icon"><use href="#i-chevron-right"/></svg></button>
            <button id="yNext" class="iconbtn" title="Next Year"><svg class="icon"><use href="#i-chevrons-right"/></svg></button>
          </div>
        </div>
        <div class="spacer-xs"></div>
        <div id="dow" class="grid"></div>
        <div id="calGrid" class="grid days"></div>
        <div class="cal-footer">
          <button id="btnToday" class="iconbtn" title="Today">
            <svg class="icon"><use href="#i-clock"/></svg>
          </button>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <button id="btnArrival">Arrival</button>
          <label class="row"><span class="muted">ETA</span>
            <select id="eta" class="input select"></select>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnDeparture">Departure</button>
          <label class="row"><span class="muted">ETD</span>
            <select id="etd" class="input select"></select>
          </label>
        </div>
      </div>

      <div class="section">
        <h2>Guests</h2>
        <div class="row nowrap" style="width:100%">
          <input id="guestName" class="input" placeholder="Name?" style="flex:1;min-width:0">
          <button id="addGuest">Add</button>
          <button id="toggleAll">Toggle All</button>
        </div>
        <div id="guests" class="chips"></div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="center card">
      <div class="row space-between nowrap" style="align-items:baseline">
        <h2>Activities</h2>
        <div class="row nowrap center-header">
          <button id="prevDay" class="iconbtn" title="Previous Day"><svg class="icon"><use href="#i-chevron-left"/></svg></button>
          <div id="dayTitle" class="muted daytitle"></div>
          <button id="nextDay" class="iconbtn" title="Next Day"><svg class="icon"><use href="#i-chevron-right"/></svg></button>
        </div>
      </div>

      <div class="row nowrap tight" style="margin:8px 0 12px">
        <button id="addDinner">Dinner</button>
        <button id="addCustom">Custom</button>
        <button id="clearAll">Clear</button>
      </div>

      <div id="activities" class="list" style="flex:1;min-height:0;overflow:auto"></div>
    </section>

    <!-- RIGHT -->
    <section class="right card">
      <h2>Preview</h2>
      <div id="email" class="email" contenteditable="false" spellcheck="false"></div>
      <div class="row stick-right nowrap" style="gap:8px;margin-top:12px">
        <button id="toggleEdit" class="toolicon" title="Edit/Lock"><svg class="icon" id="editIcon"><use href="#i-pencil"/></svg></button>
        <button id="copy" class="toolicon" title="Copy"><svg class="icon"><use href="#i-copy"/></svg></button>
      </div>
    </section>
  </div>

<script>
/*** UTILITIES ***/
const pad=n=>String(n).padStart(2,'0');
const ordinal=(n)=>{const s=["th","st","nd","rd"],v=n%100;return n+(s[(v-20)%10]||s[v]||s[0])};
const hmToAmPm=(hm)=>{let[h,m]=hm.split(':').map(Number);const am=h<12;h=((h+11)%12)+1;return `${h}:${pad(m)}${am?'am':'pm'}`};
const weekdayName=d=>d.toLocaleDateString(undefined,{weekday:'long'});
const monthName=(y,m)=>new Date(y,m,1).toLocaleString(undefined,{month:'long'});
const fmtDateKey=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const fromDateKey=k=>{const [y,m,d]=k.split('-').map(Number);return new Date(y,m-1,d)};

/*** STATE ***/
const state={
  today:new Date(),
  focus:new Date(),
  monthView:null,
  arrival:null, departure:null,
  eta:'12:00', etd:'13:00',
  guests:[], // {name,color,primary,active}
  colors:['var(--chip1)','var(--chip2)','var(--chip3)','var(--chip4)'],
  itemsByDate:new Map(), // key => [{start,end,title,type,guests:Set(names)}]
  emailLocked:false, emailDirty:false,
  program: defaultProgram()
};
const el={
  dow:document.getElementById('dow'),
  grid:document.getElementById('calGrid'),
  month:document.getElementById('calMonth'),
  year:document.getElementById('calYear'),
  email:document.getElementById('email'),
  activities:document.getElementById('activities'),
  dayTitle:document.getElementById('dayTitle'),
  guests:document.getElementById('guests'),
  eta:document.getElementById('eta'),
  etd:document.getElementById('etd'),
};

/*** THEME ***/
(function bootTheme(){
  const saved=localStorage.getItem('chs-theme');
  if(saved==='dark') document.body.classList.add('theme-dark');
  setThemeIcon();
  document.getElementById('themeToggle').addEventListener('click',()=>{
    document.body.classList.toggle('theme-dark');
    localStorage.setItem('chs-theme', document.body.classList.contains('theme-dark')?'dark':'light');
    setThemeIcon();
  });
})();
function setThemeIcon(){
  document.getElementById('themeUse')
    .setAttribute('href',document.body.classList.contains('theme-dark')?'#i-sun':'#i-moon');
}

/*** BUILD 12H TIME SELECTS ***/
function label12(h,m){
  const am = h<12;
  const hh = ((h+11)%12)+1;
  return `${hh}:${pad(m)}${am?'am':'pm'}`;
}
function buildTimeSelect(sel, defaultHM){
  sel.innerHTML='';
  for(let mins=0; mins<24*60; mins+=15){
    const h=Math.floor(mins/60), m=mins%60;
    const v = `${pad(h)}:${pad(m)}`;
    const opt=document.createElement('option');
    opt.value=v; opt.textContent=label12(h,m);
    sel.appendChild(opt);
  }
  sel.value = defaultHM;
}
buildTimeSelect(el.eta,'12:00');
buildTimeSelect(el.etd,'13:00');

/*** CALENDAR ***/
el.dow.innerHTML='';
['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const c=document.createElement('div');c.className='dow';c.textContent=d;el.dow.appendChild(c);});

function renderCalendar(){
  const ref = state.monthView? new Date(state.monthView.y, state.monthView.m, 1)
                             : new Date(state.focus.getFullYear(), state.focus.getMonth(), 1);
  el.month.textContent = monthName(ref.getFullYear(), ref.getMonth());
  el.year.textContent = ref.getFullYear();

  el.grid.innerHTML='';
  const first=new Date(ref.getFullYear(),ref.getMonth(),1);
  const startWd=first.getDay(); // Sun=0
  const totalCells=42; // 6 fixed rows so layout never jumps
  for(let i=0;i<totalCells;i++){
    const dateObj=new Date(ref.getFullYear(),ref.getMonth(),1 - startWd + i);
    const inMonth = dateObj.getMonth()===ref.getMonth();
    const btn=document.createElement('button'); btn.className='day'+(inMonth?'':' faded'); btn.textContent=dateObj.getDate();
    const today=new Date(); today.setHours(0,0,0,0);
    const cd=new Date(dateObj); cd.setHours(0,0,0,0);
    if(cd.getTime()===today.getTime()) btn.classList.add('today');
    if(state.arrival){const a=new Date(state.arrival).setHours(0,0,0,0); if(cd.getTime()===a) btn.classList.add('arrival')}
    if(state.departure){const d=new Date(state.departure).setHours(0,0,0,0); if(cd.getTime()===d) btn.classList.add('departure')}
    if(state.arrival && state.departure){
      const a=new Date(state.arrival).setHours(0,0,0,0); const d=new Date(state.departure).setHours(0,0,0,0);
      const k=cd.getTime(); if(k>a&&k<d) btn.classList.add('stay');
    }
    if(cd.toDateString()===state.focus.toDateString()) btn.classList.add('focus');
    btn.addEventListener('click',()=>{
      state.focus=new Date(dateObj);
      if(!inMonth){ state.monthView={y:dateObj.getFullYear(),m:dateObj.getMonth()} }
      renderAll();
    });
    el.grid.appendChild(btn);
  }
  // nav
  document.getElementById('mPrev').onclick=()=>{ const y=ref.getFullYear(),m=ref.getMonth()-1; state.monthView={y:y+(m<0?-1:0), m:(m+12)%12}; renderCalendar() };
  document.getElementById('mNext').onclick=()=>{ const y=ref.getFullYear(),m=ref.getMonth()+1; state.monthView={y:y+(m>11?1:0), m:(m+12)%12}; renderCalendar() };
  document.getElementById('yPrev').onclick=()=>{ state.monthView={y:ref.getFullYear()-1,m:ref.getMonth()}; renderCalendar() };
  document.getElementById('yNext').onclick=()=>{ state.monthView={y:ref.getFullYear()+1,m:ref.getMonth()}; renderCalendar() };
}
document.getElementById('btnToday').onclick=()=>{ state.focus=new Date(); state.monthView=null; renderAll() };

/*** GUESTS ***/
function renderGuests(){
  const wrap=el.guests; wrap.innerHTML='';
  state.guests.forEach((g,i)=>{
    const chip=document.createElement('div'); chip.className='chip'; chip.classList.add(g.active?'on':'off');
    chip.style.borderColor=g.active? g.color : '#cfd6e7'; chip.style.color=g.active? 'var(--ink)' : '#7d8aa0';
    const star=g.primary? '<span class="star">⋆</span>' : '';
    chip.innerHTML=`${star}<strong>${g.name}</strong>`;
    chip.addEventListener('click',(e)=>{ if(e.target.classList.contains('x')) return; g.active=!g.active; renderGuests(); renderActivities(); });
    const x=document.createElement('span'); x.className='x'; x.textContent='×';
    const onRemove=(e)=>{ e.preventDefault(); e.stopPropagation(); const wasPrimary=state.guests[i].primary; state.guests.splice(i,1); if(wasPrimary && state.guests[0]) state.guests[0].primary=true; renderGuests(); renderActivities(); renderEmail(); };
    x.addEventListener('pointerdown',onRemove); x.addEventListener('click',onRemove);
    chip.appendChild(x);
    wrap.appendChild(chip);
  });
}
document.getElementById('addGuest').onclick=()=>{ const n=document.getElementById('guestName'); addGuest(n.value); n.value=''; n.focus(); }
document.getElementById('guestName').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); const n=e.target; addGuest(n.value); n.value=''; }});
document.getElementById('toggleAll').onclick=()=>{ const anyOff=state.guests.some(g=>!g.active); state.guests.forEach(g=>g.active=anyOff); renderGuests(); renderActivities(); };
function addGuest(name){
  name=name?.trim(); if(!name) return;
  const color=state.colors[state.guests.length % state.colors.length];
  const primary=state.guests.length===0;
  state.guests.push({name,color,primary,active:true});
  renderGuests(); renderActivities(); renderEmail();
}

/*** ACTIVITIES ***/
let pop=null, popFor=null;
function closePop(){ if(pop){ document.body.removeChild(pop); pop=null; popFor=null; } }
document.addEventListener('pointerdown',(e)=>{ if(pop && !pop.contains(e.target)) closePop(); }, {capture:true});

function ensureDayList(key){ if(!state.itemsByDate.has(key)) state.itemsByDate.set(key,[]) }
function keyFor(it){ return `${it.start}|${it.end||''}|${it.title}` }
function programForDate(d){ return (state.program[weekdayName(d)]||[]).map(x=>({...x})) }

function renderActivities(){
  const d=state.focus;
  document.getElementById('dayTitle').textContent = `${weekdayName(d)}, ${monthName(d.getFullYear(),d.getMonth())} ${ordinal(d.getDate())}`;
  const base=programForDate(d);
  const key=fmtDateKey(d);
  const added=(state.itemsByDate.get(key)||[]);
  const addedMap=new Map(added.map(it=>[keyFor(it),it]));
  const list=el.activities; list.innerHTML='';

  function row(item){
    const existing = addedMap.get(keyFor(item));
    const merged = existing ? existing : {...item, type:'activity'};

    const row=document.createElement('div'); row.className='item';
    const left=document.createElement('div');
    const t=document.createElement('div'); t.className='title'; t.textContent=merged.title;
    const time=document.createElement('div'); time.className='time'; time.textContent = merged.end? `${hmToAmPm(merged.start)} - ${hmToAmPm(merged.end)}` : hmToAmPm(merged.start);

    // chips
    if(merged.guests && merged.guests.size){
      const names=Array.from(merged.guests);
      const everyone = state.guests.length>0 && names.length===state.guests.length;
      if(everyone){
        const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Everyone'; tag.setAttribute('role','button'); tag.tabIndex=0; tag.title='Show guests';
        const open=()=>{
          if(popFor===tag) return;
          closePop();
          const r=tag.getBoundingClientRect();
          pop=document.createElement('div'); pop.className='pop';
          names.forEach(n=>{
            const chip=document.createElement('span'); chip.className='initial'; chip.textContent=(n[0]||'?').toUpperCase();
            chip.style.color=(state.guests.find(g=>g.name===n)?.color||'#2a6bff');
            const removeOne=(e)=>{ e.preventDefault(); e.stopPropagation(); const s=new Set(merged.guests); s.delete(n); merged.guests=s; if(s.size===0){ const arr=state.itemsByDate.get(key)||[]; const idx=arr.indexOf(merged); if(idx>-1) arr.splice(idx,1) } closePop(); renderAll(); };
            chip.addEventListener('pointerdown',removeOne); chip.addEventListener('click',removeOne);
            pop.appendChild(chip);
          });
          document.body.appendChild(pop);
          const top = Math.max(8, r.top + window.scrollY - pop.offsetHeight - 8);
          const left = Math.min(window.innerWidth - pop.offsetWidth - 8, Math.max(8, r.left + window.scrollX));
          pop.style.top = `${top}px`; pop.style.left = `${left}px`;
          popFor=tag;
        };
        tag.addEventListener('pointerdown',(e)=>{ e.preventDefault(); e.stopPropagation(); if(popFor===tag){ closePop() } else { open() }});
        tag.addEventListener('mouseenter',()=>{ if('ontouchstart' in window) return; open(); });
        tag.addEventListener('mouseleave',()=>{ if('ontouchstart' in window) return; if(popFor===tag) return; });
        t.appendChild(tag);
      } else {
        names.forEach(n=>{
          const chip=document.createElement('span'); chip.className='initial'; chip.textContent=(n[0]||'?').toUpperCase(); chip.title=n;
          chip.style.color=(state.guests.find(g=>g.name===n)?.color||'#2a6bff');
          const removeOne=(e)=>{ e.preventDefault(); e.stopPropagation(); const s=new Set(merged.guests); s.delete(n); merged.guests=s; if(s.size===0){ const arr=state.itemsByDate.get(key)||[]; const idx=arr.indexOf(merged); if(idx>-1) arr.splice(idx,1) } renderAll(); };
          chip.addEventListener('pointerdown',removeOne); chip.addEventListener('click',removeOne);
          t.appendChild(chip);
        });
      }
    }

    left.append(t,time);
    const right=document.createElement('div');
    const add=document.createElement('button'); add.textContent='+'; add.title='Add for toggled guests';
    add.onclick=()=>{ const actives=state.guests.filter(g=>g.active).map(g=>g.name); if(actives.length===0){ alert('Toggle at least one guest first.'); return } ensureDayList(key); const arr=state.itemsByDate.get(key); const target=addedMap.get(keyFor(item))||merged; const s=new Set(target.guests||[]); actives.forEach(n=>s.add(n)); target.guests=s; if(!arr.includes(target)) arr.push(target); state.emailDirty=false; renderAll(); };
    right.appendChild(add);

    row.append(left,right);
    list.appendChild(row);
  }

  base.forEach(it=>row(it));
  added.filter(it=>!base.some(b=>keyFor(b)===keyFor(it))).sort((a,b)=>a.start.localeCompare(b.start)).forEach(it=>row(it));
}
document.getElementById('prevDay').onclick=()=>{ const d=new Date(state.focus); d.setDate(d.getDate()-1); state.focus=d; state.monthView=null; renderAll(); };
document.getElementById('nextDay').onclick=()=>{ const d=new Date(state.focus); d.setDate(d.getDate()+1); state.focus=d; state.monthView=null; renderAll(); };

/*** EMAIL ***/
function generateEmail(){
  const pg=state.guests.find(g=>g.primary);
  const hello=pg? pg.name : 'Guest';
  const lines=[];
  lines.push(`Hello ${hello},`,'','Current Itinerary:');
  const dayKeys=new Set(Array.from(state.itemsByDate.keys()));
  if(state.arrival) dayKeys.add(fmtDateKey(state.arrival));
  if(state.departure) dayKeys.add(fmtDateKey(state.departure));
  const keys=Array.from(dayKeys).sort();
  for(const k of keys){
    const items=(state.itemsByDate.get(k)||[]).slice().sort((a,b)=>a.start.localeCompare(b.start));
    const isArr=state.arrival && k===fmtDateKey(state.arrival);
    const isDep=state.departure && k===fmtDateKey(state.departure);
    if(items.length===0 && !isArr && !isDep) continue;
    lines.push('', dateHeadingFromKey(k));
    if(isArr) lines.push(`4:00pm Guaranteed Check-In | Welcome to arrive as early as 12:00pm`);
    for(const it of items){
      const timeTxt = it.end ? `${hmToAmPm(it.start)} - ${hmToAmPm(it.end)}` : hmToAmPm(it.start);
      lines.push(`${timeTxt} | ${it.title}`);
    }
    if(isDep) lines.push(`11:00am Check-Out | Welcome to stay on property until 1:00pm`);
  }
  return lines.join('\n');
}
function dateHeadingFromKey(k){ const d=fromDateKey(k); return `${weekdayName(d)}, ${d.toLocaleString(undefined,{month:'long'})} ${ordinal(d.getDate())}`; }
function renderEmail(){ if(state.emailLocked || state.emailDirty) return; el.email.textContent = generateEmail(); }
document.getElementById('toggleEdit').onclick=()=>{ const evt=new Event('dblclick'); evt.metaKey=true; el.email.dispatchEvent(evt); };
el.email.addEventListener('dblclick',(e)=>{ if(!(e.metaKey||e.ctrlKey)) return; state.emailLocked=!state.emailLocked; el.email.contentEditable=state.emailLocked; document.querySelector('#editIcon use').setAttribute('href', state.emailLocked?'#i-lock':'#i-pencil'); if(state.emailLocked) state.emailDirty=true; });
el.email.addEventListener('input',()=>{ if(state.emailLocked) state.emailDirty=true });
document.getElementById('copy').onclick=async()=>{ const text=el.email.textContent; try{ await navigator.clipboard.writeText(text); alert('Copied email to clipboard'); }catch(e){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Copied (fallback)') }};

/*** CONTROLS ***/
document.getElementById('btnArrival').onclick=()=>{ const d=new Date(state.focus); if(state.departure && d>state.departure){ alert('Arrival cannot be after Departure.'); return } state.arrival=d; state.emailDirty=false; renderAll(); };
document.getElementById('btnDeparture').onclick=()=>{ const d=new Date(state.focus); if(state.arrival && d<state.arrival){ alert('Departure cannot be before Arrival.'); return } state.departure=d; state.emailDirty=false; renderAll(); };
el.eta.onchange=(e)=>{ state.eta=e.target.value; renderAll(); };
el.etd.onchange=(e)=>{ state.etd=e.target.value; renderAll(); };
// shortcuts (require Cmd/Ctrl)
document.addEventListener('keydown',e=>{
  if(!(e.metaKey||e.ctrlKey)) return;
  if(e.key==='t'||e.key==='T'){ e.preventDefault(); state.focus=new Date(); state.monthView=null; renderAll(); }
  if(e.key==='a'||e.key==='A'){ e.preventDefault(); const d=new Date(state.focus); if(state.departure && d>state.departure){ alert('Arrival cannot be after Departure.'); return } state.arrival=d; state.emailDirty=false; renderAll(); }
  if(e.key==='d'||e.key==='D'){ e.preventDefault(); const d=new Date(state.focus); if(state.arrival && d<state.arrival){ alert('Departure cannot be before Arrival.'); return } state.departure=d; state.emailDirty=false; renderAll(); }
  if(e.key===','||e.code==='Comma'){ e.preventDefault(); const d=new Date(state.focus); d.setDate(d.getDate()-1); state.focus=d; state.monthView=null; renderAll(); }
  if(e.key==='.'||e.code==='Period'){ e.preventDefault(); const d=new Date(state.focus); d.setDate(d.getDate()+1); state.focus=d; state.monthView=null; renderAll(); }
});
// quick add / clear
document.getElementById('addDinner').onclick=()=>{ const hm=prompt('Dinner start time (e.g., 7:00pm; 15-min steps 5:30pm–8:00pm; excluding 6:45pm):','7:00pm'); if(!hm) return;
  const norm=parse12(hm); if(!norm){ alert('Invalid dinner time.'); return }
  const [H,M]=norm.split(':').map(Number); const mins=H*60+M;
  const ok=!(mins<17*60+30||mins>20*60||M%15!==0||norm==='18:45'); if(!ok){ alert('Invalid dinner time.'); return }
  const key=fmtDateKey(state.focus); ensureDayList(key); const actives=state.guests.filter(g=>g.active).map(g=>g.name); if(actives.length===0){ alert('Toggle at least one guest first.'); return }
  state.itemsByDate.get(key).push({start:norm,end:null,title:'Dinner at Harvest',type:'dinner',guests:new Set(actives)}); state.emailDirty=false; renderAll();
};
document.getElementById('addCustom').onclick=()=>{ const title=prompt('Custom title:','Custom Activity'); if(!title) return; const s=prompt('Start time (e.g., 10:00am):','10:00am'); if(!s) return; const start=parse12(s); if(!start) return alert('Invalid start time.'); const e=prompt('End time (e.g., 11:00am, optional):',''); const end=e?parse12(e):null; const key=fmtDateKey(state.focus); ensureDayList(key); const actives=state.guests.filter(g=>g.active).map(g=>g.name); if(actives.length===0){ alert('Toggle at least one guest first.'); return } state.itemsByDate.get(key).push({start,end,title,type:'custom',guests:new Set(actives)}); state.emailDirty=false; renderAll(); };
document.getElementById('clearAll').onclick=()=>{ state.arrival=null; state.departure=null; state.itemsByDate=new Map(); state.guests=[]; el.eta.value='12:00'; el.etd.value='13:00'; state.eta='12:00'; state.etd='13:00'; state.emailLocked=false; state.emailDirty=false; el.email.contentEditable=false; document.querySelector('#editIcon use').setAttribute('href','#i-pencil'); closePop(); renderAll(); };

/*** TIME PARSER (12h string -> "HH:MM") ***/
function parse12(s){
  if(!s) return null;
  const m = String(s).trim().toLowerCase().match(/^(\d{1,2}):(\d{2})\s*([ap])m$/);
  if(!m) return null;
  let h=+m[1], min=+m[2]; const ap=m[3];
  if(h<1||h>12||min<0||min>=60) return null;
  if(ap==='p' && h!==12) h+=12;
  if(ap==='a' && h===12) h=0;
  return `${pad(h)}:${pad(min)}`;
}

/*** RENDER ALL ***/
function renderAll(){ renderCalendar(); renderGuests(); renderActivities(); renderEmail(); }

/*** DEFAULT PROGRAM (placeholder Monday you gave me) ***/
function defaultProgram(){
  return {
    "Sunday":[{"start":"09:30","end":"10:15","title":"Nature Walk"}],
    "Monday":[
      {"start":"06:45","end":"08:15","title":"Overlook Hike"},
      {"start":"07:00","end":"09:15","title":"Scenic Desert E-Bike Ride"},
      {"start":"07:00","end":"10:00","title":"Castle Peak Via Ferrata Climb"},
      {"start":"07:00","end":"10:00","title":"Crater Canyon Exploration"},
      {"start":"08:30","end":"09:25","title":"Rise & Shine Flow Yoga"},
      {"start":"09:00","end":"10:15","title":"E-Biking 101: Intro to E-Bike Tour"},
      {"start":"09:30","end":"10:15","title":"Landscape Restoration and Development Tour"},
      {"start":"09:40","end":"10:00","title":"Meditation"},
      {"start":"10:00","end":"10:45","title":"Guided Archery"},
      {"start":"10:15","end":"11:00","title":"Intro to Tai Chi"},
      {"start":"10:30","end":"11:30","title":"Farm Tour"},
      {"start":"11:00","end":"11:45","title":"Axe Throwing"},
      {"start":"11:00","end":"12:00","title":"Paddle Board Yoga"},
      {"start":"12:30","end":"13:30","title":"Sound Bath"},
      {"start":"14:00","end":"14:45","title":"Mindfulness Activity - Rock Mandalas"},
      {"start":"14:00","end":"15:00","title":"Cooling Aroma Restorative Yoga"},
      {"start":"15:00","end":"16:00","title":"Wine Tasting"},
      {"start":"15:15","end":"16:10","title":"Yoga"},
      {"start":"16:00","end":"16:45","title":"Castle Hot Springs Documentary Viewing"},
      {"start":"16:00","end":"17:00","title":"Connecting With Water"},
      {"start":"16:30","end":"17:00","title":"Yoga Nidra"}
    ],
    "Tuesday":[{"start":"09:00","end":"12:00","title":"UTV Razor Tour"},{"start":"16:00","end":"17:00","title":"Farm Tour"}],
    "Wednesday":[{"start":"10:15","end":"11:00","title":"Intro to Tai Chi"}],
    "Thursday":[{"start":"11:30","end":"12:15","title":"Guided Archery"}],
    "Friday":[{"start":"12:30","end":"13:30","title":"Sound Bath"}],
    "Saturday":[{"start":"09:00","end":"10:00","title":"Morning Stretch"}]
  };
}

document.addEventListener('DOMContentLoaded', renderAll);
</script>
</body>
</html>
